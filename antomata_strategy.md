## 1. まずルールを「3つの現象」に分解して捉える

このオートマトンは見た目が複雑ですが、実際に起きることは概ね次の3種類です。

### A) 静的オブジェクトは不変

* **壁 # / 穴 o / 餌 $ はその場に固定**（周囲に何があっても変化しない）

### B) アリ自身のセルは「前方だけ」で決まる（まず消える／その場で右折／前方アリで分岐）

中心セルがアリのとき、基本はこうです：

* 前方が **床 -**：そのセルは次状態で **床になる**（＝アリは前進して出ていく）
* 前方が **穴 o**：そのセルは次状態で **床になる**（＝穴に落ちて消滅）
* 前方が **壁 #**：そのセルは次状態で **右を向いたアリになる**（固定の右折）
* 前方が **アリ**：ここで初めて **p4〜p7（相手の向きで分岐）** が効く

> 重要：アリのセルは「横に誰がいるか」より、「前が何か」が最優先で決まります（パターン適用が上から順）。

### C) 床セルは「誰が入ってくるか」で決まる（衝突／勝者1匹／全滅）

アリが移動してくる“着地点”は、**床セル側の更新規則**でアリが生成されます。

床セルに対して、

* 下から `^`、左から `>`、右から `<`、上から `v`
  のように **“その床に向かっているアリ”** がいると、そこへ入ろうとします。

そのとき

* 1匹だけなら **p1**
* 2匹（L字に入る）なら **p2**
* 3匹（T字に入る）なら **p3**
* 向きが決められない（対向・完全対称など）なら **全滅（anteater）で床**
  …という理解で攻略すると一気に見通しが良くなります。

---

## 2. p1..p7 の意味（攻略上の“スイッチ”）を固定して考える

各 clan の “turning machine” は p1..p7 の7個の出力（N/E/S/W）です。
そして **N/E/S/W は絶対方角ではなく「いま向いてる向きからの相対」**です。

* N：そのまま（直進の向き）
* E：右へ90°
* S：反転（180°）
* W：左へ90°

攻略では p1..p7 を「どの状況のとき、どっちへ向きを変えるか」のスイッチとして扱います。

### p1 が一番重要になりやすい

**“普通に床へ前進した直後にどう向くか”** が p1 なので、
盤面に他のアリが絡まない区間では、ほぼ p1 だけで軌道が決まります。

典型例（障害物が少ないときの挙動イメージ）：

* p1=N：基本直進（壁に当たると必ず右折）
* p1=E：毎歩右折気味（ループしやすい）
* p1=W：毎歩左折気味
* p1=S：ジグザグや往復が発生しやすい

### p4〜p7 は「前にアリがいて詰まったときの回避規則」

前方がアリのときにだけ使われます。
相手のアリが自分に対してどう向いてるか（同方向／右向き／逆向き／左向き）で p4..p7 を使い分ける、という役割です。

→ なので **他のアリを早めに消して単独行動にする**ほど、p4..p7 を考えなくて済みます。

### p2/p3 は「合流点で勝ち残るアリの向き」

衝突・合流が避けられないパターンで効きます。
逆に言うと、盤面設計で合流を潰せれば p2/p3 も不要になりがちです。

---

## 3. “勝利条件”を最大限悪用する（最重要の近道）

勝利は「餌に到達して食べる」ではなく、**次の配置が現れた瞬間に終了**です：

```
  *
 *$*
  ^
```

つまり、

* **餌($)の真下にアリがいて**
* **餌の方向を向いている（餌に向かって `^`）**

これが盤面に出た瞬間クリアです。

補足: ルールが回転不変なので、成功判定も回転不変（餌に隣接して向いている蟻）で確定です。
`ant_solver.py` では facing で `puzzle1/2/5/15` が成功し、`--success-below` 判定では失敗。
UMIX の `./antomaton puzzle1_solution.ant` で `Ant reached goal!` を確認済み（ログ: `volume9_gardener_antomaton_verify_p1_umodem.txt`）。

### まず最初にやるべきチェック

各パターンで：

1. 餌($)の位置を確認
2. その真下のマスが `*`（ワイルドカード）や自由に置けるなら
   → **そこに clan 任意の `^` を置いて即勝ち**できないか？

パターン制約によっては、これだけで複数ステージが一瞬で終わります。

---

## 4. 手で解くときの基本方針（めちゃ効く）

### 方針A：まず「勝ち役の1匹」以外は消す

この系は、アリが多いほど分岐（p2〜p7）が増えて難しくなります。
逆に言うと、**余計なアリを穴や anteater で消して**しまえば、

* 必要な未知変数が激減
* ほぼ p1（＋壁で右折）だけの迷路問題になる

#### 消し方（定番）

* 穴 `o` を進行方向に置いて落とす
  （アリは穴を“嗅げない”のでそのまま消える）
* 対称衝突（非可 orientable）をわざと作って **anteater で掃除**
  （「v と ^ が向かい合って同じ床に突っ込む」など）

> 盤面ワイルドカード `*` に穴を置けるなら、“掃除装置”として非常に強いです。

---

### 方針B：勝ち役のアリは「壁で右折」を利用して誘導する

壁にぶつかると clan に無関係で必ず右折なので、
**壁だけで曲がり角を作れる**のが強みです。

そこで、

* 勝ち役アリの p1 を **なるべく単純（N 直進など）**に置く
* 曲げたい場所だけ壁で右折させる
* 不要な枝へ行きそうなら穴で落とす

という “迷路作り” に寄せると解が出やすいです。

---

### 方針C：ワイルドカードはまず全部「床 -」で埋めて動かしてみる

パズル系CAあるあるですが、最初から凝った配置にしない方が早いです。

1. 盤面 `*` を全部 `-`（床）で仮埋め
2. turning machine の `*` も全部仮に N で埋め
3. `./antomaton -i world.ant` でステップ実行
4. **勝ち筋を邪魔している原因だけ**を局所的に変更

変更対象はだいたい次のどれかに収束します：

* 「このアリがここで曲がれば勝ち」→ p1 を変える or 角に壁
* 「このアリ邪魔」→ 穴を置く
* 「合流で死ぬ」→ 合流自体を避ける配置にする（p2/p3調整より先）

---

## 5. 自動化して解く戦略（強い順に3案）

パターン数が多い／手で追うのが辛い場合の方針です。

### 案1：バックトラック＋シミュレーション（実装が簡単で強い）

未知は主に

* turning machine の `*`（最大 10×7 だけど、実際に使う clan は少ない）
* 盤面の `*`

ですが、**実際に挙動に影響する未知は「シミュレーションで参照されたものだけ」**です。

やり方：

1. 仮に全部適当に埋めて走らせる
2. 実行中、「どの clan のどの p_i が参照されたか」をログる（最初の分岐点）
3. その p_i を 4通り（N/E/S/W）で分岐して試す
4. 勝ち or ループ（盤面が過去状態に戻る）で打ち切り
5. 深さ優先で探索

**ポイント**

* グリッドが有限なので、同じ盤面が再登場したら以降は永久ループ＝失敗確定
  → ループ検出が最強の枝刈りになります。
* 盤面 `*` も同じで、「勝ち役の進路近く」以外は床に固定して探索から外すと爆速。

---

### 案2：未知を「勝ち役の周辺だけ」に限定して探索

盤面 `*` が多いときは特に効きます。

* 最初は **餌($)からマンハッタン距離 d 以内**だけを可変にする（d=2〜4 くらい）
* それ以外の `*` は床 `-` に固定
* それでダメなら d を増やす

「勝利条件が局所（餌の真下）」なので、周辺構造を先に作るのが合理的です。

---

### 案3：SAT/SMT で“逆算”（一番強いが実装重め）

これは最終兵器です。

* 時刻 t=0..H の各セル状態を変数化
* 更新規則（局所ルール）を制約として追加
* どこかの時刻で勝利パターンが成立する制約を入れる
* turning machine の `*` も変数

で解けます。
H（手数上限）を 10, 20, 30… と増やしていくと見つかることが多いです。

---

## 6. 解くときの“よくある勝ち筋テンプレ”

最後に、パターンを見た瞬間に狙うべきテンプレを置いておきます。

### テンプレ1：即勝ち配置できないか

* `$` の下が `*` → そこに `^` を置く

### テンプレ2：1匹だけ残して迷路で誘導

* 他は穴 or anteater で掃除
* 勝ち役は p1=N に寄せ、壁の右折で誘導

### テンプレ3：合流点を作らない（p2/p3を使わない設計）

* p2/p3 は“調整沼”になりやすい
* まずは **合流が起きない盤面**に寄せる
